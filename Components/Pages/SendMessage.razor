@page "/message"
@using EventStreamApp.Models
@using IBM.WMQ

@rendermode InteractiveServer

<PageTitle>DemoApp</PageTitle>

<FluentStack Style="padding-top:1em;padding-bottom:1em" Orientation="Orientation.Horizontal">
    <FluentIcon Title="Welcome" Value="@(new Icons.Regular.Size32.Mail())"></FluentIcon>
    <FluentLabel Typo="Typography.H3">Send a message to queue</FluentLabel>
</FluentStack>

<FluentStack Style="padding-top:1em; padding-bottom:1em" Orientation="Orientation.Vertical">
    <FluentSelect Appearance="Appearance.Filled" TOption="string" Label="Select queue name" ValueChanged="QueueNameChanged"
                  Width="356px" Placeholder="Select queue name" Items="queueNames" SelectedOption="selectedQueue" />
    <FluentTextArea Appearance="FluentInputAppearance.Filled" Rows="8" Cols="50" Label="@payloadLabel" ValueChanged="UpdateMessage" Value="@Message">
    </FluentTextArea>
</FluentStack>

<FluentStack Orientation="Orientation.Horizontal" Width="356px">
    <FluentButton IconStart="@(new Icons.Regular.Size24.DocumentSync())" Disabled="@(selectedQueue.Length == 0)" Appearance="Appearance.Accent" @onclick="GetRandomData">Get random data</FluentButton>
    <FluentSpacer />
    <FluentButton IconStart="@(new Icons.Regular.Size24.Send())" Disabled="@(Message.Length == 0 || !isMessageValid)" Appearance="Appearance.Accent" @onclick="SendMessageToMQ">Send message</FluentButton>
</FluentStack>

@code {
    [Inject]
    private ILogger<SendMessage> logger { get; set; } = default!;

    [Inject]
    private IFakeDataService fakeDataService { get; set; } = default!;

    [Inject]
    private IConfiguration configuration { get; set; } = default!;

    private string hostname = string.Empty;
    private string channel = string.Empty;
    private string queueManager = string.Empty;
    //private string queueName = string.Empty;
    private int port;

    private Hashtable connectionProperties = new Hashtable();
    private string Message { get; set; } = string.Empty;
    private string payloadLabel = "Payload";

    private string[] queueNames = ["TRANSFER", "CUSTOMER"];
    private string selectedQueue { get; set; } = "CUSTOMER";
    private bool isMessageValid = true;

    protected override void OnInitialized()
    {
        hostname = configuration["IbmMq:Hostname"]!;
        channel = configuration["IbmMq:Channel"]!;
        queueManager = configuration["IbmMq:QueueManager"]!;
        //queueName = configuration["IbmMq:QueueName"]!;
        port = int.Parse(configuration["IbmMq:Port"]!);
        connectionProperties.Add(MQC.TRANSPORT_PROPERTY, MQC.TRANSPORT_MQSERIES_MANAGED);
        connectionProperties.Add(MQC.HOST_NAME_PROPERTY, hostname);
        connectionProperties.Add(MQC.CHANNEL_PROPERTY, channel);
        connectionProperties.Add(MQC.PORT_PROPERTY, port);
        GetRandomData();
    }


    private void GetRandomData()
    {
        if (selectedQueue == "CUSTOMER")
        {
            Message = fakeDataService.GetFakeCustomerData();
        }
        else
        {
            Message = fakeDataService.GetFakeTransferData();
        }
        payloadLabel = "Payload";
        isMessageValid = true;
    }

    private void UpdateMessage(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            Message = string.Empty;
            isMessageValid = false;
            return;
        }

        Message = value;
        var jsonString = value.Trim();
        if ((jsonString.StartsWith("{") && jsonString.EndsWith("}")) || // For object
            (jsonString.StartsWith("[") && jsonString.EndsWith("]")))   // For array
        {
            try
            {
                var obj = JsonDocument.Parse(jsonString);
                isMessageValid = true;
            }
            catch (Exception)
            {
                payloadLabel = "Invalid payload!";
                isMessageValid = false;
            }
        }
        else
        {
            payloadLabel = "Invalid payload!";
            isMessageValid = false;
        }
    }

    private void SendMessageToMQ()
    {
        try
        {
            MQQueueManager qManager = new MQQueueManager(queueManager, connectionProperties);
            int openOptions = MQC.MQOO_INPUT_AS_Q_DEF | MQC.MQOO_OUTPUT;
            MQQueue queue = qManager.AccessQueue(selectedQueue, openOptions);
            MQMessage msg = new MQMessage();
            msg.CharacterSet = MQC.CODESET_UTF;
            msg.WriteString(Message);
            MQPutMessageOptions pmo = new MQPutMessageOptions();
            queue.Put(msg, pmo);
            Message = "";
            payloadLabel = "Payload sent!";
        }
        catch (Exception ex)
        {
            logger.LogError(ex, ex.Message);
        }
    }

    private void QueueNameChanged(string newValue)
    {
        selectedQueue = newValue;
        GetRandomData();
        StateHasChanged();
    }
}
